# serverless

## Running Offline

Need to create a `serverless-config/secrets.json` file of the following signature. The values do not have to be real for development purposes.

```javascript
{
  "AUTH_SECRET": "<auth_secret>",
  "ADMIN_SECRET": "<admin_secret>",
  "AWS_ACCESS_KEY_ID": "<access_key>",
  "AWS_SECRET_ACCESS_KEY": "<secret_access_key>",
  "MONGODB_URI": "<mongo_database_uri>",
  "SQL_HOST": "<sql_host>",
  "SQL_DATABASE": "<sql_database>",
  "SQL_USERNAME": "<sql_username>",
  "SQL_PASSWORD": "<sql_password>"
}
```

```bash
yarn offline
```

## Data Sources

| usage                      | url                                                  |
| -------------------------- | ---------------------------------------------------- |
| directory of allowed users | `https://kappathetatau.org/assets/js/directory.json` |
| users                      | MongoDB                                              |
| events                     | Heroku SQL                                           |
| attendance                 | Heroku SQL                                           |

## Functions

### Sign In / Sign Up [working]

Account sign in and sign up are handled by the `login` route. A user provides their credentials which are verified against Google OAuth2 as well as our official records (`directory` data source). This information is then combined. Assuming the user passes both checks, the user is added to the database if not already present. A session token is generated by signing their email and the `AUTH_SECRET` and is returned to the user. The user then only needs their session token to authenticate and does not need to validate against Google or our records.

1. client signs in with google
2. client sends google credentials to backend
3. backend verifies email against directory data source
4. backend verifies google token
5. backend generates a JWT
6. backend creates new user in database if not found
7. returns authorized data and the generated token

### General Authentication [working]

Header authorization is handled by middleware. Step 3 is handled by each route that requires authorization. After authorization occurs, the data will be automatically attached to the route's `event` object and is accessible. See `users/update-one.js` for an example. The middleware will automatically assume authorization is required **unless specified otherwise** in the route's `middyfy` call.

1. client sends bearer token
2. backend verifies token against email
3. executes action and returns authorized data

### Privileges

Privileges are stored in official records in the `directory` data source. These are transitioned into the user database upon account creation. Exec transitions happen once yearly. To propogate changes to the `directory`, the `auto/update-roles.js` route will verify each user in the database against the `directory` and strip/add privileges and rolls where necessary.

- looked up during initial login from directory and saved to database
- auto-route that updates privileges and roles across the board
